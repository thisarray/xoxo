<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tic Tac Toe</title>
  <style type="text/css" media="screen">
body {
  background-color: white;
  color: black;
}
output {
  display: block;
  margin-bottom: 1em;
  margin-left: 1em;
}
pre {
  font-family: "Courier New", monospace;
  font-size: 40px;
  line-height: 40px;
  text-transform: full-width;
}
table {
  border-collapse: collapse;
  font-size: 36px;
  line-height: 36px;
  margin: 0;
  padding: 0;
  text-align: center;
}
td {
  background-color: white;
  border: 1px solid black;
  color: black;
  height: 38px;
  width: 38px;
}
.O {
  color: red;
}
.X {
  color: blue;
}
  </style>
</head>

<body>

<main>
<h1>Tic Tac Toe</h1>

<p><label for="size">Size:</label> <input type="number" id="size" name="size" value="3" min="3"></p>

<output id="board"></output>
<p id="marker"></p>
<button id="new">New board</button>

<p>Connect markers in a row, a column, or a diagonal.</p>
</main>

<script src="board.js"></script>
<script>
Board.test();

/*
 * Size in pixels of each square.
 */
const SCALE = 40;

class Display {
  constructor(parent, marker) {
    if (!(parent instanceof Node)) {
      throw new TypeError('Bad DOM parent.');
    }
    this.parent = parent;

    if (!(marker instanceof Node)) {
      throw new TypeError('Bad DOM parent.');
    }
    this.marker = marker;
  }
  draw(board) {
    if (board.playerWin) {
      this.marker.innerHTML = `Player: <span class="${board.playerMarker}">${board.playerMarker} (won)</span> Computer: <span class="${board.computerMarker}">${board.computerMarker} (lost)</span>`;
      alert('You won!');
    }
    else if (board.computerWin) {
      this.marker.innerHTML = `Player: <span class="${board.playerMarker}">${board.playerMarker} (lost)</span> Computer: <span class="${board.computerMarker}">${board.computerMarker} (won)</span>`;
      alert('You lost!');
    }
    else {
      this.marker.innerHTML = `Player: <span class="${board.playerMarker}">${board.playerMarker}</span> Computer: <span class="${board.computerMarker}">${board.computerMarker}</span>`;
      if (board.done) {
        alert('You tied.');
      }
    }
  }
}

class ASCIIDisplay extends Display {
  draw(board) {
    let target = this.parent.querySelector('pre');
    if (target == null) {
      this.parent.innerHTML = '';
      target = document.createElement('pre');
      this.parent.appendChild(target);
    }
    target.textContent = board.rows.join('\n');
    super.draw(board);
  }
}

class CanvasDisplay extends Display {
  draw(board) {
    let target = this.parent.querySelector('canvas'),
        width = board.width * SCALE,
        height = board.height * SCALE,
        middle = SCALE / 2;
    if (target == null) {
      this.parent.innerHTML = '';
      target = document.createElement('canvas');
      this.parent.appendChild(target);
    }
    if ((target.width != width) || (target.height != height)) {
      target.width = width;
      target.height = height;
    }

    let context = target.getContext('2d');
    context.clearRect(0, 0, width, height);

    context.lineWidth = 5;
    for (let y = 0; y < board.height; y++) {
      for (let x = 0; x < board.width; x++) {
        let marker = board.get(x, y);
        if (marker == X_MARKER) {
          context.strokeStyle = '#0000FF';
          context.beginPath();
          context.moveTo((x * SCALE) + 5, (y * SCALE) + 5);
          context.lineTo(((x + 1) * SCALE) - 5, ((y + 1) * SCALE) - 5);
          context.moveTo(((x + 1) * SCALE) - 5, (y * SCALE) + 5);
          context.lineTo((x * SCALE) + 5, ((y + 1) * SCALE) - 5);
          context.stroke();
        }
        if (marker == O_MARKER) {
          context.strokeStyle = '#FF0000';
          context.beginPath();
          context.arc((x * SCALE) + middle, (y * SCALE) + middle, middle - 5, 0, 2 * Math.PI);
          context.stroke();
        }
      }
    }

    // Draw grid lines
    context.lineWidth = 1;
    context.strokeStyle = '#000000';
    for (let x = 1; x < board.width; x++) {
      context.beginPath();
      context.moveTo(x * SCALE, 0);
      context.lineTo(x * SCALE, height);
      context.stroke();
    }
    for (let y = 1; y < board.height; y++) {
      context.beginPath();
      context.moveTo(0, y * SCALE);
      context.lineTo(width, y * SCALE);
      context.stroke();
    }

    super.draw(board);
  }
}

class TableDisplay extends Display {
  draw(board) {
    let target = this.parent.querySelector('table');
    if (target == null) {
      this.parent.innerHTML = '';
      target = document.createElement('table');
      this.parent.appendChild(target);
    }

    let rows = [];
    for (let y = 0; y < board.height; y++) {
      let row = [];
      row.push('  <tr>');
      for (let x = 0; x < board.width; x++) {
        let marker = board.get(x, y);
        row.push(`    <td class="${marker}">${marker}</td>`);
      }
      row.push('  </tr>');
      rows.push(row.join('\n'));
    }
    target.innerHTML = rows.join('\n');
    super.draw(board);
  }
}

const output = document.querySelector('#board');
const marker = document.querySelector('#marker');
const size = document.querySelector('#size');
//const display = new ASCIIDisplay(output, marker);
const display = new CanvasDisplay(output, marker);
//const display = new TableDisplay(output, marker);

let board = null;
function newBoard(event) {
  if (Math.random() < 0.5) {
    board = new Board(size.value, size.value, size.value, X_MARKER, O_MARKER);
  }
  else {
    // Computer makes the first move
    board = new Board(size.value, size.value, size.value, O_MARKER, X_MARKER);
    let {x, y} = board.getComputerMove();
    board = board.mark(x, y, true);
  }
  display.draw(board);
}

size.addEventListener('change', newBoard);
output.addEventListener('click', (event) => {
  if (board.done) {
    return;
  }

  let box = output.getBoundingClientRect(),
      x = Math.min(Math.floor((event.clientX - box.left) / SCALE), board.width - 1),
      y = Math.min(Math.floor((event.clientY - box.top) / SCALE), board.height - 1),
      previous = board;
  if (x < 0) {
    x = 0;
  }
  if (y < 0) {
    y = 0;
  }
  board = board.mark(x, y);
  if (board != previous) {
    // If the player actually changed the board (didn't click on an occupied square)
    display.draw(board);
    if (!board.done) {
      let {x, y} = board.getComputerMove();
      board = board.mark(x, y, true);
      display.draw(board);
    }
  }
});
document.querySelector('#new').addEventListener('click', newBoard);

newBoard();
</script>
</body>

</html>
